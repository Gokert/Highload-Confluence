# Проектирование высоконагруженного пространства для командной работы

Курсовая работа в рамках 3-го семестра программы по Веб-разработке ОЦ VK x МГТУ им. Н.Э. Баумана (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных сервисов"

#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчет нагрузки](#2)
3. [Расчет глобальной нагрузки](#3)
4. [Расчет локальной нагрузки](#4)
5. [Логическая схема БД](#5)
6. [Физическая схема БД](#6)
7. [Алгоритмы](#7)
8. [Технологии](#8)
9. [Обеспечение надёжности](#9)
10. [Схема проекта](#10)
11. [Список серверов](#11)
12. [Список Литературы](#12)

## Часть 1. Тема и целевая аудитория <a name="1"></a>

### Тема курсовой работы - **"Проектирование сервиса для командной работы"**
Confluence — это удобное рабочее пространство для удаленных команд, в котором участники могут хранить знания и сотрудничать друг с другом. В приложении Confluence Cloud можно легко записывать возникшие идеи, создавать и редактировать страницы и совместно работать с командой практически на любом устройстве.


### Ключевой функционал сервиса
- Поиск и навигация по документам.
- Просмотр документов.
- Создание и редактирование документов.

### Целевая аудитория
- Весь мир
- 25 млн пользователей в месяц (MAU) [^1]
- 0.84 млн пользователей в день (DAU) [^1]

## Часть 2. Расчет нагрузки <a name="2"></a>

### Продуктовые метрики

### Среднее количество действий пользователя по типам в день.
Допустим, в день пользователь совершает 10 посещений. Таким образом при ежедневном посещении 0.84 млн пользователей количество просмотров страниц будет равно 0.84 * 10 = 8.4 млн. На основе личного опыта предположим, что около 1 страницы пользователь находит по поиску, а навигация по сайту 10 - 1 = 9.
Тогда получается, что на поиск уходит 0.84 млн просмотров страниц, а на переход по ссылкам и навигацию внутри сайта уходит 7.56 млн просмотров.

#### Создание и редактирование страниц.
Допустим, в день пользователь делает 2 вправки. Тогда при ежедневном посещении 0.84 млн пользователей количество вправок будет равно:
```
0.84 * 2 = 1.68 млн.
```
Допустим, что количество созданий документов равняется 5% от числа вправок. Тогда новых документов в день равняется:
```
1.68 * 0.05 = 0.084 млн.
```

| Действие пользователя  | Количество в день |
|------------------------|-------------------|
| Поиск                  | 840 000           |
| Навигация              | 7 560 000         |
| Просмотр документов    | 8 400 000         |
| Создание документов    | 84 000            |
| Редактирование         | 1 680 000         |

В среднем одна картинка равняется 500 КБ.
В среднем на одного пользователя приходится 2 ГБ за 5 лет. Тогда за один день он занимает новые 1 МБ. Откуда получаем объем памяти, затрачиваемой каждый день: 
```
0.84 млн * 1 МБ = 820 ГБ.
```

За 5 лет памяти всего было затрачено:
```
5 * 365 * 820 = 1.32 ПБ. 
```

Найдём общее число документов: 

[//]: # (```)

[//]: # (5 * 365 * 84 000 = 551 880 000.)

[//]: # (```)

```
5 * 365 * 84 000 = 163 300 000.
```

[//]: # (153 300 000)

Найдём средний вес документа: 

[//]: # (```)

[//]: # (5.78 ПБ / 551 880 000 = 11 МБ.)

[//]: # (```)

```
1.32 ПБ / 163 300 000 = 8.2 МБ.
```

[//]: # (1.32 / 163 300 000 = 8.2 МБ)

В среднем на статью приходится [620 слов](https://thequickadvisor.com/how-many-links-does-wikipedia-have/), а средняя длина слов равняется 5 буквам. 1 символ в Unicode кодируется 2 байтами. Статья также имеет ID - 16б (UUID).

Средний объём памяти текстом:
```
(620 * 5 * 2 + 16) / 8 = 777 байт.
```

Допустим, что в среднем добавляется одна новая картинка (в среднем одна картинка 500 КБ) и текст.

#### Сводная таблица продуктовых метрик
| Характеристика                                           |    Метрика    |
|:---------------------------------------------------------|:-------------:|
| MAU                                                      |      25M      |
| DAU                                                      |     0.84М     |
| Общее число документов                                   |    163.3 М    |
| Среднее время просмотра страницы                         |    5.26 м     |
| Средний размер документа                                 |    8.2 МБ     |
| Средний размер вправки документа                         |    500 КБ     |
| Среднее количество действий по просмотру документов      |  8.4 M/сутки  |
| Среднее количество поисков по документам                 | 0.84 M/сутки  |
| Среднее количество действий по созданию документов       | 0.084 М/сутки |
| Среднее количество действий по редактированию документов | 1.68 М/сутки  |

### Технические метрики:

Найдём среднее число картинок на документ. Из общего среднего веса картинки вычтем вес текста и делим на средний размер картинки.
```
(8.2 Мб - 777 байт) / 500 КБ = (8396 КБ - 0.75 КБ) / 500 КБ = 17
```

[//]: # ( &#40;8396 - 0.75&#41; / 500 = 16)

Размер хранения текста: 
```
0.77 КБ * 163 300 000 = 0.12 ТБ
```

Размер хранения картинок: 
```
17 * 500 КБ * 163 300 000 = 1.29 ПТ 
```

[//]: # (16 * 500Kb * 163 300 000 = 1.18 Пт)


RPS по просмотру документов: 
```
8 400 000 / (60 * 60 * 24) = 97.2
```

RPS по созданию документов: 
```
84 000 / (60 * 60 * 24) = 0.97
```

RPS по редактированию документов: 
```
1 680 000  / (60 * 60 * 24) = 19.4
```

RPS по поиску документов:
```
840 000 / ( 60 * 60 * 24 ) = 9.7 RPS
```


Путь до картинки занимает в среднем 16 байт. Возьмем небольшой коэффициент k=1,5 отличия от среднего трафика для получения пикового трафика по просмотру документов: 
```
97.2 * (777 Байт + 16 * 16 Байт) * 1.5 = 0.144 ГБ/с
```

Возьмем небольшой коэффициент k=1,5 отличия от среднего трафика для получения пикового трафика по созданию документов: 
```
0.97 * (777 Байт) * 1.5 = 1.1 КБ/с
```

Возьмем небольшой коэффициент k=1,5 отличия от среднего трафика для получения пикового трафика по редактированию документов: 
```
19.4 * 0.5 МБ * 1.5 = 0.015 Гб/с
```

В среднем одно слово занимает 5 букв. Тогда при поиске будет отправлять 5 байт.
Возьмем небольшой коэффициент k=1,5 отличия от среднего трафика для получения пикового трафика по поиску документов:
```
9.7 * 5  * 1.5 = 73 Байт/с
```

Пиковое потребление в течение суток:
```
0.144 + 0.015 = 0.159 ГБ/с
```

Cуммарный суточного трафик: 
```
(97.2 * (777 Байт + 16 * 16 Байт) + 0.97 * (777 Байт) + 19.4 * 0.5) * (24 * 60 * 60) = 8.94 TБ/сутки
```

#### Сводная таблица технических метрик
| Характеристика                      |    Метрика    |
|:------------------------------------|:-------------:|
| Размер хранения текста              |    0.11 ТБ    |
| Размер хранения картинок            |    1.29 ПТ    |
| Пиковое потребление в течении суток | 0.159 ГБ/сек  |
| Суммарный суточный                  | 8.94 TБ/сутки |
| RPS по просмотру документов         |     97.2      |
| RPS по созданию документов          |     0.97      |
| RPS по редактированию документов    |     19.4      |
| RPS по поиску документов            |      9.7      |


## Часть 3. Расчет глобальной нагрузки <a name="3"></a>

### Расстановка серверов компании atlassian.
![img_5.png](/images/img_5.png)

Расположение ДЦ
Основная аудитория находится в Северной и Южной Америке, Европе и Юго-восток Азии.
Расположим ДЦ в соответствии с географическим положением.

Тогда:

1. Расположим ДЦ в Нью-Йорке и Сан-Франциско (крупнейшие центры, отвечают за трафик восточного и западного побережья).

2. Сан-Паулу (крупнейший город и центр трафика Бразилии, отвечает за Бразилию).

3. Франкфурт (одна из крупнейших развязок в Европе и мире, отвечает за Европу).

4. Лондон (крупнейший узел Великобритании, отвечает за Британию).

5. Сингап (столица Сингапура, отвечает за Индию, юг Азии и Океанию).

6. Сидней (крупнейший узел в Австралии, отвечает за Австралию).

### Выбор способа глобальной балансировки

Предлагаю балансировку клиентов между регионами (Америка, Европа, Азия) осуществлять через привязку IP-адресов ДЦ к третьестепенным доменам компаний, указанным в URL-запросе.
Так, при обращении к domain-name.atlassian.net, DNS вернет IP того ДЦ, где зарегистрирована компания.
Такая схема позволит пользователям со всего мира подключаться к тому центру, через который обслуживается их компания.

## Часть 4. Расчет локальной нагрузки <a name="4"></a>
### L7 балансировка

Будем использовать сервер Nginx. Использовать его будем для следующих процессов:

* Отдача статики 
* Сжатие контента (gzip)
* Отслеживание обработки медленных клиентов (с помощью использования асинхронной обработки)
* SSL терминация.

Также Nginx осуществляет балансировку на ноды Kubernetes.
Kubernetes выполняет auto-scaling, перезапускает сервисы при падении. Это обеспечивает отказоустойчивость.

## Часть 5. Логическая схема БД <a name="5"></a>
![img_8.png](images/img_8.png)

|     Таблица      |                                                                                                                       Описание                                                                                                                        |
|:----------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|     Sessions     |                                                                                                             Хранение сессий пользователей                                                                                                             |
|      Users       |                                                                                                                    Таблица юзеров                                                                                                                     |
|       Acl        |                                                                                                             Таблица прав юзеров к папкам                                                                                                              |
|    Documents     |                                                                                                                  Таблица документов                                                                                                                   |
|     Versions     |                                                                                                           Таблица прошлых версий документов                                                                                                           |
|    Companies     |                                                                                                           Таблица с информацией о компаниях                                                                                                           |
| Documents_search | Таблица предназначена для поиска документов. Эта таблица является облегченной копией таблицы documents для ускорения поиска. Она содержит только название и текст documents, чтобы была возможность поиска не только по названию, но и по содержанию. |

#### Sessions
Сессионная кука весит 32 байта, дата 8 байт, id пользователя 16 байт, откуда одна строка равняется: 32 + 8 + 16 = 56 байт.

Ежемесячно на сайт заходит 25 млн пользователей, таким образом необходимая память:
```
25 000 000 * 56 = 1.3 ГБ
```
Обращение к данной таблице будет происходить при просмотре, редактировании и создании документах. Также и при полнотекстовом поиске будет обращение к данной таблице.
```
97.2 + 19.4 + 0.97 + 9.7 = 127.3 RPS
```

#### Users
Имя пользователя 16 байт, id пользователя 16 байт, email 30 байт, дата 8 байт, название компании 32 байт. Необходимая память:
```
25 000 000 * ( 16 + 16 + 30 + 8 + 32 ) = 2.37 ГБ
```
При авторизации необходимо пройтись по таблице 1 раз, в месяц это будет 25 млн. Найдём RPS:
```
25 000 000 / ( 30 * 24 * 60 * 60) = 9.7 RPS
```

#### Acl
Два id по 16 байт, права 16 байт. Общее число документов 163 300 000. Найдём необходимую память:
```
163 300 000  * ( 16 * 3 ) =  7.3 ГБ
```
Обращение к этой таблице будет всегда, когда мы редактируем и просматриваем документы. Тогда общая нагрузка будет равняться сумме RPS просмотра документов и редактированию:
```
97.2 + 19.4 = 116.6 RPS
```

#### Documents

Всего документов 163 300 000, среднее число картинок 16, средний вес текста 777 байт, название 16, две даты по 8, три id по 16:
```
163 300 000 * (16 * 16 + 16 * 3 + 16 + 777 + 8 * 2) = 169.3 ГБ
```
Обращение к этой таблице будет равняться RPS просмотра документов, изменению и созданию. Также и поиск.
```
97.2 + 19.4 + 0.97 + 9.7 = 127.3 RPS
```

#### Versions
На создание 84 тыс документов приходится 1 680 000 редактирований. В среднем на один созданный документ приходится 20 изменений.

```
163 300 000 * 20 * ( 23 * 16 + 777 + 16 * 3 ) = 3.54 ТБ
```
Обращение к этой таблице всегда будет при изменении документов. Просмотр таблицы не учитывается, так как просмотр старых версий происходит крайне редко. Тогда общее RPS равняется 19.4

#### Companies
Id на 16 байт, название компании 32 байта, в среднем на компанию 30 человек.
```
(25 млн / 30 ) * ( 30 * 16 + 32 + 16) =  0.4 Гб
```
Обращение к этой таблице будет при авторизации пользователей для просмотра и редактирования документа. Откуда получаем 116.6 RPS.


| Таблица   | Количество строк | Размер строки | Размер всех записей |  RPS  |
|:----------|:----------------:|:-------------:|:-------------------:|:-----:|
| Sessions  |      25 млн      |    56 байт    |       1.3 ГБ        | 127.3 |
| Users     |      25 млн      |   102 байт    |       2.37 ГБ       |  9.7  |
| Acl       |    163.3 млн     |    48 байт    |       7.3 ГБ        | 116.6 |
| Documents |    163.3 млн     |    1.2 КБ     |      169.3 ГБ       | 127.3 |
| Versions  |    3.27 млрд     |    1.16 КБ    |       3.54 ТБ       | 19.4  |
| Companies |     0.83 млн     |   528 байт    |       0.4 Гб        | 116.6 |

## Часть 6. Физическая схема БД <a name="6"></a>
### Выбор СУБД
![img_6.png](images/img_6.png)

|     Таблица      |  База данных  |                                                                                                                       Описание                                                                                                                        |
|:----------------:|:-------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|     Sessions     |     Redis     |                                                                                                             Хранение сессий пользователей                                                                                                             |
|      Users       |  PostgreSQL   |                                                                                                                    Таблица юзеров                                                                                                                     |
|       Acl        |  PostgreSQL   |                                                                                                             Таблица прав юзеров к папкам                                                                                                              |
|    Documents     |  PostgreSQL   |                                                                                                                  Таблица документов                                                                                                                   |
|     Versions     |  ClickHouse   |                                                                                                           Таблица прошлых версий документов                                                                                                           |
|    Companies     |  PostgreSQL   |                                                                                                           Таблица с информацией о компаниях                                                                                                           |
| Documents_search | ElasticSearch | Таблица предназначена для поиска документов. Эта таблица является облегченной копией таблицы documents для ускорения поиска. Она содержит только название и текст documents, чтобы была возможность поиска не только по названию, но и по содержанию. |
|      Фотки       |     CEPH      |                                                                                                                   Хранение картинок                                                                                                                   |

Так как в таблице Documents много данных и поиск полнотекстовый по нему в Postgresql будет долгим,
то для ускорения поиска необходимо выделить новую таблицу Documents_search, которая будет расположена в ElasticSearch. 
В этой таблице будет находиться название документа и текст документа, чтобы совершать полнотекстовый поиск по названию и тексту документа.

### Индексы
Индексировать необходимо следующие столбцы для ускорения запросов:
* Таблица Users: id
* Таблица Acl: (user_id, doc_ud)
* Таблица Documents: id
* Таблица Versions: doc_id
* Таблица Documents_search: id
* Таблица Companies: id

### Нормализация
В таблице Companies присутствует массив id работников, чтобы отсутствовали лишние join между таблицами.
В таблицах Documents и Versions присутствуют массивы путей картинок, вместо созданий 3х таблиц с лишними join.

### Клиентские библиотеки
Так как мы используем язык Go, то для подключения к СУБД будем использовать следующие библиотеки:

* Для подключения ElasticSearch: olivere/elastic
* Для подключения PostgreSQL: jackc/pgx
* Для подключения Redis: go-redis
* Для подключения CEPH: go-ceph
* Для подключения ClickHouse: clickhouse-go

### Шардирование
* для таблицы Users организуем шардинг по id.
* для таблицы Documents организуем шардинг по id.
* для таблицы Versions организуем шардинг по doc_id.
* для таблицы Companies организуем шардинг по id.
* для таблицы Acl организуем шардинг по doc_id.
* для таблицы Documents_search организуем шардинг по id.

### Репликация
* для таблицы Users организуем репликацию по Master-Slave.
* для таблицы Documents организуем репликацию по Master-Slave.
* для таблицы Versions организуем репликацию по Multi-Master.
* для таблицы Companies организуем репликацию по Master-Slave.
* для таблицы Acl организуем репликацию по Master-Slave.
* для таблицы Documents_search организуем репликацию по Master-Slave.

### Балансировака запросов / мультиплексирование подключений
Для мультиплексирования подключений в PostgreSQL будем использовать pgBouncer.

### Схема резервного копирования
Будет использоваться комбинированное резервное копирование,
суть которого заключается в регулярном выполнении полного резервного копирования (раз в месяц) совместно с инкрементными (изменившиеся данные) копированиями в промежутках между ними (раз в день).
Бэкап будем брать с одной из реплик. Другая реплика будет использоваться для "горячего" резерва.

## Часть 7. Алгоритм <a name="7"></a>

### Поиск
Пользователям требуется быстро находить нужные документы по ключевым словам. Поскольку полнотекстовый поиск в PostgreSQL медленный, 
мы будем использовать ElasticSearch, который обеспечивает более быстрый полнотекстовый поиск.

Создадим копию таблицы documents в ElasticSearch, которую назовем documents_search.

В качестве анализатора будем использовать стандартный анализатор ElasticSearch, 
который разбивает текст на токены согласно алгоритму Unicode Text Segmentation и приводит полученные токены к нижнему регистру.

Выгрузим данные из PostgreSQL в ElasticSearch и создадим обратные индексы для ускорения поиска. 
В процессе индексации будет создан список всех слов, используемых в документах, и для каждого слова будет "запомнено", 
в каких документах оно встречается. Хотя процесс индексации может занять некоторое время, наша основная цель - обеспечить высокую скорость поиска.

После выполнения поиска необходима сортировка по степени их релевантности. Это называется ранжирование. 
Ранжирование выполняется с использованием модели TF/IDF (Частота Термина/Обратная Частота Документа).

Суть модели TF/IDF заключается в следующем:
* Частота термина (TF): Это мера того, насколько часто конкретное слово или фраза встречаются в документе. Если слово встречается часто, его важность в контексте документа растет.
* Обратная частота документа (IDF): Это мера того, насколько часто слово встречается во всех документах. Если слово встречается в большинстве документов, его значение понижается, так как оно становится менее дифференцирующим.

Сочетание TF и IDF позволит ранжировать документы по степени их релевантности для конкретного поискового запроса.
Также используем функцию скоринга для настройки ранжирования, чтобы установить, что заголовок документа (дадим ему вес 2) важнее его содержимого (тексту дадим вес 1), и Elasticsearch будет учитывать это при ранжировании результатов.

После результаты будут отображаться в порядке убывания релевантности.

## Часть 8. Технологии <a name="8"></a>

| Технология    |                Область применения                 |                                                                                           Мотивация                                                                                           |
|:--------------|:-------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| Golang        |                      Backend                      |                              Простота, своя модель параллелизма, сборщик мусора, cистема модулей, большое количество технологий из коробки, производительность.                               |
| React         |                     Frontend                      |                                                    Cбалансирован как с точки зрения сложности, так и с точки зрения богатства функционала.                                                    |
| Nginx         |                   Load balancer                   |                                              Надежный и функциональный балансировщик, выступающий в том числе в качестве сервера раздачи статики                                              |
| Redis         |              Пользовательских сессий              |                                                                    Легко масштабируется, большое комьюнити, очень быстрый                                                                     |
| Kubernetes    |             Развертывание приложения              |                                                       автоматизирует процессы развертывания, масштабирования и управления контейнерами                                                        |
| CEPH          |                Хранилище картинок                 |                                                                                       Хранение картинок                                                                                       |
| Kafka         | Асинхронный стриминговый сервис, брокер сообщений |                                                    Высокая пропускная способность и низкая задержка, масштабируемость, большое сообщество                                                     |
| ClickHouse    |                     Database                      |                                                Высокая производительность при выполнении аналитических запросов над большими объемами данных.                                                 |
| ElasticSearch |                       Поиск                       | Хранилище данных для поиска, анализа и хранения в реальном времени. Предоставляет расширенные возможности поиска, включая полнотекстовый поиск, фасетный поиск, ранжирование результатов и др |
| Prometheus    |              Сбор и хранение метрик               |                                                                         Возможность создания гибких запросов к данным                                                                         |
| Grafana       |   Визуализация метрик для мониторинга сервисов    |                                                                                   Гибкая настройка графиков                                                                                   |
| PostgreSQL    |                     Database                      |                                  надежная и мощная реляционная база данных. Она поддерживает сложные запросы, транзакции и обеспечивает целостность данных.                                   |
| PgBouncer     |                      Backend                      |                                                                         мультиплексирование подключений в postgresql                                                                          |

## Часть 9. Обеспечение надёжности <a name="9"></a>

### Отказоустойчисвость БД
1. Резервирование БД:
    * PostgreSQL: Master-Slave репликация с помощью встроенной Streaming replication по 2 реплики
    * ClickHouse: по 1 реплике с ReplicatedMergeTree
    * CEPH: установим 1 реплику.
    * Kafka: один брокер выступает в роли лидера (мастера), а остальные следуют за ним (слейвы). Слейвы синхронно реплицируют сообщения с мастера. Replication factor = 3.
    * Резервное копирование: Сочетание полного резервного копирования (ежемесячно) с инкрементными копиями (ежедневно), используя одну реплику для бекапа и другую для "горячего" резерва.    
 
2. Резервирование физических компонентов (сервера, диски и т.д.)

### Надежность сервисов
* re-try запросы с дедлайном только от frontend.
* Failover policy: Rate limiter клиентских запросов по IP для защиты от DDoS-атак и предотвращения перегрузки серверов.
* Graceful shutdown: Будем использовать Graceful Node Shutdown в Kubernetes, чтобы при остановке сервиса, не терялись обрабатываемые в этот момент запросы
* Graceful degradation: Функции с наибольшим трафиком находятся в приоритете, скорее всего при отказе компонентов не получится поддержать функциональность на 100%. 
Для Confluence критичной функциональностью будет авторизация, просмотр и редактирование документов (permission, documents, outbox processor). Функциональность, которая имеет право "отвалиться": полнотекстовый поиск по документам (search, worker).
* [Outbox](https://habr.com/ru/companies/lamoda/articles/678932/): Данный паттерн решает проблему потери событий. Он обеспечивает запись не только данных в базу данных, но и создание сообщений для их последующей обработки в других базах данных.
  Специальный обработчик outbox processor читает сообщения из базы данных и помещает их в Kafka. В случае, если не удается установить связь с брокером сообщений, будет предпринята повторная попытка отправки сообщения (ограниченное количество попыток).
  Таким образом, сообщения не будут потеряны, поскольку они всегда находятся в базе данных на стороне обработчика outbox, и после восстановления брокера будет произведена повторная отправка данных. А для борьбы с дупликацией данных worker будет проверять в бд, было ли такое сообщение или нет.


### Observalvability
* Сбор метрик, логов с сервисов.
* Регулярный запуск профилировщика для выявления узких мест производительности. Профилирование сервисов с помощью golang pprof

## Часть 10. Схема проекта <a name="10"></a>

[//]: # (![img_7_3.png]&#40;/images/img_7_3.png&#41;)
![img_7_4.png](/images/img_7_4.png)


__Permission Service__ - сервис, обеспечивающий авторизацию пользователей и хранение их прав.


__Documents service__ - сервис, реализующий создание документов, сохранение картинок, отдачу документов пользователю.
Через Kafka обеспечивается синхронизация данных документов с сервисом Search service, так как у этих сервисов должны быть одинаковые данные о документах.   


__Search service__ - сервис, обеспечивающий поиск по документам через ElasticSearch.
Через Kafka обеспечивается синхронизация данных документов с сервисом Documents service, так как у этих сервисов должны быть одинаковые данные о документах.

[Механизм копирования](https://habr.com/ru/companies/lamoda/articles/678932/) реализован на основе паттерна Outbox transaction заключается в разделении пайплайнов для чтения и записи в БД. Запись в БД происходит асинхронно - микросервис __outbox processor__ получает из бд данные и кладет их в виде сообщений в Kafka,
а затем другой микросервис __worker__ достает эти сообщения и записывает данные в ElasticSearch. Даже если Kafka станет недоступной, то все сообщения будут сохранены в таблице outbox messages и потому не будут потеряны. После чего все не отправленные сообщения в брокер будут отправлены.



| Сервис             |                                      Информация                                       |
|:-------------------|:-------------------------------------------------------------------------------------:|
| Permission Service |               Таблицы User, Acl, Companies в PostgreSQL, сессии в Redis               |
| Documents service  |    Таблица Documents, outbox в PostgreSQL, Versions в ClickHouse, картинки в CEPH     |
| Search service     |                       Таблица Documents_search в ElasticSearch                        |
| outbox processor   | получает новые данные из БД и отправляет в брокер. Таблица outbox table  в PostgreSQL |
| worker             |           необходим для получения данных из Kafka и вставки в ElasticSearch           |

## Часть 11. Список серверов <a name="11"></a>

### Базовый расчёт аппаратных ресурсов

Производительность для go:

| Технология | Характер сервиса      | RPS  | RAM    |
|------------|-----------------------|------|--------|
| go         | тяжелая бизнес-логика | 10   | 100 Mb |
| go         | средняя бизнес-логика | 100  | 100 Mb |
| go         | легкое JSON API       | 5000 | 10 Mb  |


| Service     |  RPS  | CPU | RAM  |    Net     |
|:------------|:-----:|:---:|:----:|:----------:|
| Permission  | 127.3 |  2  | 3 Гб |  257 МБ/с  |
| Documents   | 127.3 |  2  | 2 Гб | 0.159 ГБ/с |
| Search      |  9.7  |  1  | 1 Гб | 73 Байт/с  |

[//]: # (и 1 ГБ RAM на 1000 запросов)

Конфигурация для [Nginx](https://github.com/init/highload/blob/main/highload_l11_hosting.md):

| Name       |  RPS  | CPU |  RAM  |    Net     |
|:-----------|:-----:|:---:|:-----:|:----------:|
| Nginx      | 127.3 |  1  | 10 МБ | 0.163 ГБ/с |


### Конфигурации серверов

Определяем конфигурацию машин для каждого сервиса.
Будем использовать облачный хостинг виртуальных машин.
Подсчитаем стоимость аренды в месяц в [калькуляторе](https://azure.microsoft.com/en-gb/pricing/calculator/) хостинга. Картинок суммарно на 1.3 ПБ.
Все сервисы будут в облачном хостинге, а картинки на own, по причине дороговизны хранения их в облаке.

[//]: # (| Название      |   Хостинг    |          Конфигурация          | Cores | Cnt | Цена $ &#40;одна штука&#41; | Амортизация &#40;сумма, на 5 лет&#41; |)

[//]: # (|:--------------|:------------:|:------------------------------:|:-----:|:---:|:-------------------:|:-----------------------------:|)

[//]: # (| kube node     | Amazon Cloud | Xeon E5-2637/2x4Gb/1xNVMe128GB |   ?   |  ?  |          ?          |               ?               |)

[//]: # (| Redis         | Amazon Cloud | Xeon E5-2637/2x4Gb/1xNVMe128GB |   ?   |  ?  |          ?          |               ?               |)

[//]: # (| PostgreSQL    | Amazon Cloud |   Xeon E5-2637/2x4Gb/4TBNVMe   |   ?   |  ?  |          ?          |               ?               |)

[//]: # (| ElasticSearch | Amazon Cloud |   Xeon E5-2637/2x4Gb/1TBNVMe   |   ?   |  ?  |          ?          |               ?               |)

[//]: # (| ClickHouse    | Amazon Cloud |  Xeon E5-2637/2x4Gb/8x4TBNVMe  |   ?   |  ?  |          ?          |               ?               |)

[//]: # (| CEPH          | Amazon Cloud |  Xeon E5-2637/2x4Gb/6x4TBNVMe  |   ?   |  ?  |          ?          |               ?               |)

#### Северная Америка.
2 Дц

Предполагаем[1](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/audience-geography/*/999/28d?key=atlassian.com&webSource=Total), [2](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/audience-geography/*/999/28d?key=confluence.atlassian.com&webSource=Total), 
что здесь до 40% общей нагрузки

[//]: # (| Сервис           | Хостинг       | Конфиг                                   | Кол-во | )

[//]: # (|------------------|---------------|------------------------------------------|--------|)

[//]: # (| nginx            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| permission       | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| search           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| documents        | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| outbox processor | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| worker           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| PostgreSQL       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 128 ГБ   | 6      | )

[//]: # (| ClickHouse       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 4 TБ     | 2      | )

[//]: # (| Redis            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| Kafka            | Digital Ocean | 1 core CPU/ 1x2 GB RAM/  1x NVMe 128 ГБ  | 3      | )

[//]: # (| CEPH             | Digital Ocean | 2 core CPU/ 5x128 GB RAM/ 40x NVMe 16 TБ | 2      |)

| Сервис           | Хостинг       | Конфиг                                 | Кол-во | Аренда в месяц $ (1 ед.)      | Цена  |
|------------------|---------------|----------------------------------------|--------|-------------------------------|-------|
| nginx            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| permission       | Digital Ocean | 2 core CPU/ 4 GB RAM                   | 1      | 80                            |       |
| search           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| documents        | Digital Ocean | 2 core CPU/ 2 GB RAM                   | 1      | 80                            |       |
| outbox processor | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| worker           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| PostgreSQL       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 128 ГБ   | 6      | 90                            |       |
| ClickHouse       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 4 ТБ     | 2      | 400                           |       |
| Redis            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| Kafka            | Digital Ocean | 1 core CPU/ 2 GB RAM/  1x NVMe 128 ГБ  | 3      | 50                            |       |
| CEPH             | own           | i5-13500/ 5*128 GB RAM/ 40x NVMe 16 TБ | 2      | 1000   (амортизация на 5 лет) | 60000 |


[//]: # (| Название      | Хостинг |            Конфигурация             | Cores | Cnt | Аренда $ &#40;в месяц&#41; | )

[//]: # (|:--------------|:-------:|:-----------------------------------:|:-----:|:---:|:------------------:|)

[//]: # (| kube node     |  Azure  | 1 core CPU/ 1x2 GB RAM/ 1xNVMe128GB |   1   | 5?  |         40         |)

[//]: # (| Redis         |  Azure  |       1 core CPU/ 1x2 GB RAM        |   1   |  1  |         30         |)

[//]: # (| PostgreSQL    |  Azure  | 1 core CPU/ 1x2 GB RAM/ 1xNVMe 4Tb  |   1   |  6  |        330         |)

[//]: # (| ElasticSearch |  Azure  | 1 core CPU/ 1x2 GB RAM/ 1xNVMe 1Tb  |   1   |  3  |        110         |)

[//]: # (| ClickHouse    |  Azure  | 1 core CPU/ 1x2 GB RAM/ 3xNVMe 4Tb  |   1   |  2  |         ?          |)

[//]: # (| Kafka         |  Azure  | 1 core CPU/ 1x2 GB RAM/ 1xNVMe128GB |   1   |  3  |         ?          |)

[//]: # (| CEPH          |  Azure  | 1 core CPU/ 1x2 GB RAM/ 6xNVMe 4Tb  |   1   |  3  |         ?          |)

#### Южная Америка.
Предположительно до 15% общей нагрузки

[//]: # (| Сервис           | Хостинг       | Конфиг                                   | Кол-во | )

[//]: # (|------------------|---------------|------------------------------------------|--------|)

[//]: # (| nginx            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| permission       | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| search           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| documents        | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| outbox processor | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| worker           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| PostgreSQL       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 128 ГБ   | 6      | )

[//]: # (| ClickHouse       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 1 TБ     | 2      | )

[//]: # (| Redis            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| Kafka            | Digital Ocean | 1 core CPU/ 1x2 GB RAM/  1x NVMe 128 ГБ  | 3      | )

[//]: # (| CEPH             | Digital Ocean | 2 core CPU/ 2x128 GB RAM/ 10x NVMe 16 TБ | 2      |)


| Сервис           | Хостинг       | Конфиг                                 | Кол-во | Аренда в месяц $ (1 ед.)    | Цена  |
|------------------|---------------|----------------------------------------|--------|-----------------------------|-------|
| nginx            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| permission       | Digital Ocean | 2 core CPU/ 4 GB RAM                   | 1      | 80                          |       |
| search           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| documents        | Digital Ocean | 2 core CPU/ 2 GB RAM                   | 1      | 80                          |       |
| outbox processor | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| worker           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| PostgreSQL       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 128 ГБ   | 6      | 90                          |       |
| ClickHouse       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 1 ТБ     | 2      | 160                         |       |
| Redis            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| Kafka            | Digital Ocean | 1 core CPU/ 2 GB RAM/  1x NVMe 128 ГБ  | 3      | 50                          |       |
| CEPH             | own           | i5-13500/ 2*128 GB RAM/ 10x NVMe 16 TБ | 2      | 320  (амортизация на 5 лет) | 19000 |


####  Европа.

Предположительно здесь до 30% общей нагрузки

[//]: # (| Сервис           | Хостинг       | Конфиг                                   | Кол-во | )

[//]: # (|------------------|---------------|------------------------------------------|--------|)

[//]: # (| nginx            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| permission       | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| search           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| documents        | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| outbox processor | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| worker           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| PostgreSQL       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 128 ГБ   | 6      | )

[//]: # (| ClickHouse       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 2 TБ     | 2      | )

[//]: # (| Redis            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| Kafka            | Digital Ocean | 1 core CPU/ 1x2 GB RAM/  1x NVMe 128 ГБ  | 3      | )

[//]: # (| CEPH             | Digital Ocean | 2 core CPU/ 4x128 GB RAM/ 30x NVMe 16 TБ | 2      |)


| Сервис           | Хостинг       | Конфиг                                 | Кол-во | Аренда в месяц $ (1 ед.)    | Цена  |
|------------------|---------------|----------------------------------------|--------|-----------------------------|-------|
| nginx            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| permission       | Digital Ocean | 2 core CPU/ 4 GB RAM                   | 1      | 80                          |       |
| search           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| documents        | Digital Ocean | 2 core CPU/ 2 GB RAM                   | 1      | 80                          |       |
| outbox processor | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| worker           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| PostgreSQL       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 128 ГБ   | 6      | 90                          |       |
| ClickHouse       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 2 ТБ     | 2      | 250                         |       |
| Redis            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                          |       |
| Kafka            | Digital Ocean | 1 core CPU/ 2 GB RAM/  1x NVMe 128 ГБ  | 3      | 50                          |       |
| CEPH             | own           | i5-13500/ 4*128 GB RAM/ 30x NVMe 16 TБ | 2      | 600  (амортизация на 5 лет) | 37000 |

#### Азия.

Предположительно здесь до 10% общей нагрузки

[//]: # (| Сервис           | Хостинг       | Конфиг                                   | Кол-во | )

[//]: # (|------------------|---------------|------------------------------------------|--------|)

[//]: # (| nginx            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| permission       | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| search           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| documents        | Digital Ocean | 2 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| outbox processor | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| worker           | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| PostgreSQL       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 128 ГБ   | 6      | )

[//]: # (| ClickHouse       | Digital Ocean | 2 core CPU/ 1x2 GB RAM/ 1x NVMe 512 ГБ   | 2      | )

[//]: # (| Redis            | Digital Ocean | 1 core CPU/ 1x2 GB RAM                   | 1      | )

[//]: # (| Kafka            | Digital Ocean | 1 core CPU/ 1x2 GB RAM/  1x NVMe 128 ГБ  | 3      | )

[//]: # (| CEPH             | Digital Ocean | 2 core CPU/ 2x128 GB RAM/ 10x NVMe 16 TБ | 2      |)


| Сервис           | Хостинг       | Конфиг                                 | Кол-во | Аренда в месяц $ (1 ед.)      | Цена  |
|------------------|---------------|----------------------------------------|--------|-------------------------------|-------|
| nginx            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| permission       | Digital Ocean | 2 core CPU/ 4 GB RAM                   | 1      | 80                            |       |
| search           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| documents        | Digital Ocean | 2 core CPU/ 2 GB RAM                   | 1      | 80                            |       |
| outbox processor | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| worker           | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| PostgreSQL       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 128 ГБ   | 6      | 90                            |       |
| ClickHouse       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 512 ГБ   | 2      | 120                           |       |
| Redis            | Digital Ocean | 1 core CPU/ 2 GB RAM                   | 1      | 40                            |       |
| Kafka            | Digital Ocean | 1 core CPU/ 2 GB RAM/  1x NVMe 128 ГБ  | 3      | 50                            |       |
| CEPH             | own           | i5-13500/ 2*128 GB RAM/ 10x NVMe 16 TБ | 2      | 280    (амортизация на 5 лет) | 17000 |

#### Австралия.
Предположительно здесь до 5% общей нагрузки

| Сервис           | Хостинг       | Конфиг                                | Кол-во | Аренда в месяц $ (1 ед.)   | Цена  |
|------------------|---------------|---------------------------------------|--------|----------------------------|-------|
| nginx            | Digital Ocean | 1 core CPU/ 2 GB RAM                  | 1      | 40                         |       |
| permission       | Digital Ocean | 2 core CPU/ 4 GB RAM                  | 1      | 80                         |       |
| search           | Digital Ocean | 1 core CPU/ 2 GB RAM                  | 1      | 40                         |       |
| documents        | Digital Ocean | 2 core CPU/ 2 GB RAM                  | 1      | 80                         |       |
| outbox processor | Digital Ocean | 1 core CPU/ 2 GB RAM                  | 1      | 40                         |       |
| worker           | Digital Ocean | 1 core CPU/ 2 GB RAM                  | 1      | 40                         |       |
| PostgreSQL       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 128 ГБ  | 6      | 90                         |       |
| ClickHouse       | Digital Ocean | 2 core CPU/ 4 GB RAM/ 1x NVMe 512 ГБ  | 2      | 120                        |       |
| Redis            | Digital Ocean | 1 core CPU/ 2 GB RAM                  | 1      | 40                         |       |
| Kafka            | Digital Ocean | 1 core CPU/ 2 GB RAM/  1x NVMe 128 ГБ | 3      | 50                         |       |
| CEPH             | own           | i5-13500/128 GB RAM/5x NVMe 16 TБ     | 2      | 183 (амортизация на 5 лет) | 11000 |




## Список литературы <a name="12"></a>

1. [Карта ДЦ www.atlassian.com](https://www.atlassian.com/trust/reliability/infrastructure)
2. [Глобальная карта сетевых магистралей](https://global-internet-map-2022.telegeography.com/)
3. [Распределение пользователей по странам.](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/audience-geography/*/999/3m?key=atlassian.com&webSource=Total)
4. [Принцип работы ElasticSearch](https://ai-news.ru/2023/09/osnovy_polnotekstovogo_poiska_v_elasticsearch_chast_vtoraya.html)
5. [Репликация в PostgreSQL](https://habr.com/ru/companies/otus/articles/710956/)
6. [Репликация в ClickHouse](https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/replication)
7. [Статья в habr по репликации в ClickHouse](https://habr.com/ru/companies/otus/articles/773174/)
8. [Статья о CEPH. Описание, репликация](https://habr.com/ru/articles/313644/)
9. [Статья о graceful shutdown в Kubernetes](https://habr.com/ru/companies/vk/articles/654471/)
10. [Статья о паттерне outbox](https://habr.com/ru/companies/lamoda/articles/678932/)
11. [Крупнейшие компании мира по странам #1](https://холдинги.рф/global-countries/)
12. [Крупнейшие компании мира по странам #2](https://vk.com/@investor_in_life-kak-raspredeleny-po-stranam-kompanii-lidery?ysclid=lvy6rajvs0368142552)
13. [Требования для CEPH](https://servermall.ru/blog/kak-vybrat-server-dlya-proxmox/)
14. [Калькулятор хостинга](https://azure.microsoft.com/en-gb/pricing/calculator/)
