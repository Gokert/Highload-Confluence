# Проектирование высоконагруженного пространства для командной работы

Курсовая работа в рамках 3-го семестра программы по Веб-разработке ОЦ VK x МГТУ им. Н.Э. Баумана (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных сервисов"

#### Автор - [Андрей Мышляев](https://park.vk.company/profile/a.myshliaev/ "Страница на портале VK x МГТУ")
#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчет нагрузки](#2)
3. [Расчет глобальной нагрузки](#3)
4. [Расчет локальной нагрузки](#4)

## Часть 1. Тема и целевая аудитория <a name="1"></a>

### Тема курсовой работы - **"Проектирование сервиса для командной работы"**
Confluence — это удобное рабочее пространство для удаленных команд, в котором участники могут хранить знания и сотрудничать друг с другом. В приложении Confluence Cloud можно легко записывать возникшие идеи, создавать и редактировать страницы и совместно работать с командой практически на любом устройстве.


### Ключевой функционал сервиса
- Авторизация
- Поиск по статьям
- Совместный просмотр/редактирование/создание контента (страницы с текстом, таблицами)
- Установка доступов для пользователей
- Комментирование каждой страницы

### Целевая аудитория
- Весь мир
- 25 млн уникальных пользователей в месяц (MAU) [^1]
- 1 млн уникальных пользователей в день (DAU) [^1]

## Часть 2. Расчет нагрузки <a name="2"></a>

#### Средний размер хранилища пользователя по типам:

| Хранимые данные   | Оценочный размер на пользователя         |
|-------------------|------------------------------------------|
| Аватары              | `2 Мб`                            |
| Данные профиля              | `1 Кб`                     |


**Таким образом всего:** `2 Мб 1Кб` на пользователя при вводе персональных данных.

#### Рассчитаем RPS:

|Действие пользователя |Количество / день|
| ------------- |-------------|
|Версионирование| 5 млн |
|Поиск, полнотекстовый| 15 млн |
|Линковка| 50 млн |
|Создание доков | 5 млн |
|Редактирование, совмествное| 4 млрд |
|Нотификации| 7 млн |


#### Рассчитаем объем трафика и необходимое хранилище:

| Хранимые данные   | Стартовый размер (Пб)  | Увеличение (Пб/год)    |
|-------------------|------------------------|------------------|
| Документы              | `0.015`            |        `5,209`       |
| Данные пользователя              | `1,86`  |          `647,3`         |

#### Предположим, что размер одного документа в среднем 3Кб, тогда при условии, что в день от одного юзера поступает 5 новых документов.
- Память для документов: 5 * 3 Кб * 1 млн * 365 =  5,209 Пб.
- Память дял новых юзеров: 1 млн * (2 Мб + 1 Кб) * 365 = 0.365 Тб

## Часть 3. Расчет глобальной нагрузки <a name="3"></a>

## Часть 4. Расчет локальной нагрузки <a name="4"></a>
### BGP/RIP балансировка
- В ДЦ будет стоять маршрутизатор, с помощью BGP маршрутизации будет распределять данные на балансировщик L3.
### L3/4 балансировщик
- После маршрутизатора будут стоять сервера балансировки virtual server via direct routing, 
- маршрутизатор будет отправлять на виртуальные ip адрес запрос,  балансировщик L3 будет в ethernet фрейме менять mac-адрес получателя, по загруженности серверов и отправлять его в конкретный L7 балансировщик.
- L7 балансировщик, после обработки запроса будет отправлять данные напрямую клиентам, минуя L3/4 балансировщика.
- Для отказоустойчивости будем использовать VRRP/СARP на балансировщиках.
- Для отслеживания состояния L7 балансировщиков будем использовать keepalived сервис, который будем проверять состояние l7 балансировщиков и сообщать L3.
### L7 балансировщик
- Будем использовать Envoy, как более современное решение чем nginx. Будет кешировать некоторые запросы, решать проблему "медленного клиента". С помощью Weighted Least Connections будем распределять запросы на сервисы (поднятые в подах kubernetes).
- Проблему отказоустойчивости в рамках сервисов, будет решать kubernetes. Для балансировщиков будем использовать heartbeat linux.
### SSL termination:
- Будем использовать SSL Termination, чтобы снять нагрузку с серверов по расшифровке ssl, это будет делать L7 балансировщик.
- Session cache - будет кешировать сессию.


### Список источников:
[^1]: [Статистика Atlassian](https://www.atlassian.com/ru/customers/the-telegraph)

[^2]: [Статистика Hypestat](https://hypestat.com/info/confluence.atlassian.com)

[^3]: [Данные по макс размеру](https://confluence.atlassian.com/confkb/how-to-detect-5mb-of-text-on-page-858576591.html)

